# Phase 1 - Plan 01-04: Wire Danger Scores to Scene Tags

---
wave: 1
gap_closure: true
autonomous: true
files_modified:
  - src/components/MovieBrowser/MovieCard.tsx
  - src/components/MovieDetail/MovieDetailHeader.tsx
  - src/hooks/useDangerScore.test.tsx
---

## Objective

Fix critical gap: Wire danger score calculations to actual scene tags from localStorage instead of hardcoded empty arrays. This enables the personalized danger score feature to work as intended across the app.

## Overview

**Gap Context:** Phase 1 verification identified that danger scores always show 0 because MovieCard and MovieDetailHeader use hardcoded empty tag arrays instead of calling useSceneTags hook. The tagging system and danger score calculation are both implemented correctly—they just aren't connected.

**Fix:** Replace mock/empty tag arrays with useSceneTags(movieId) calls in both components. Add integration tests to verify danger scores update when tags change.

**Impact:** Completes "Personalized danger score calculation" requirement from Phase 1 objectives.

## Acceptance Criteria

- [ ] MovieCard.tsx uses useSceneTags instead of mockTags empty array
- [ ] MovieDetailHeader.tsx uses useSceneTags instead of hardcoded empty tags
- [ ] Danger scores display correctly when tags exist for a movie
- [ ] Danger scores show 0 when no tags exist (existing behavior preserved)
- [ ] Integration tests verify scores update when tags are added/removed
- [ ] No regression in existing danger score color coding (green/yellow/red)

<task name="wire-movie-card-to-scene-tags" id="task-1">
  <objective>Replace mockTags with useSceneTags in MovieCard component</objective>
  <acceptance>
    - [ ] src/components/MovieBrowser/MovieCard.tsx updated
    - [ ] TODO comment at lines 12-13 removed
    - [ ] useSceneTags hook imported and called with movie.id
    - [ ] mockTags constant deleted
    - [ ] Danger scores now display based on actual localStorage tags
  </acceptance>
  <implementation>
Update src/components/MovieBrowser/MovieCard.tsx:

**Remove:**
```typescript
// TODO: Replace with actual scene tags from API/database
const mockTags: SceneTag[] = [];
```

**Add import:**
```typescript
import { useSceneTags } from '../../hooks/useSceneTags';
```

**Replace in component body:**
```typescript
export function MovieCard({ movie }: MovieCardProps) {
  const { selectedPhobias } = usePhobias();
  const { tags } = useSceneTags(movie.id.toString()); // NEW: Load tags from localStorage
  const { scores, getColor } = useDangerScore({
    tags, // Now uses real tags instead of empty array
    selectedPhobias,
  });
  // ... rest of component
}
```

**Verification:**
- Component still renders when no tags exist (tags = empty array)
- When tags exist in localStorage for a movie, danger scores display correctly
- Traffic-light color coding works (green ≤30, yellow 31-70, red >70)

**No other changes needed:** The rest of MovieCard already handles the scores object correctly.
  </implementation>
</task>

<task name="wire-detail-header-to-scene-tags" id="task-2">
  <objective>Replace hardcoded empty tags with useSceneTags in MovieDetailHeader</objective>
  <acceptance>
    - [ ] src/components/MovieDetail/MovieDetailHeader.tsx updated
    - [ ] TODO comment at lines 15-16 removed
    - [ ] useSceneTags hook imported and called with movie.id
    - [ ] Danger scores section displays real data based on tags
    - [ ] Overall danger score updates when tags exist
    - [ ] Phobia-specific scores show correct values
  </acceptance>
  <implementation>
Update src/components/MovieDetail/MovieDetailHeader.tsx:

**Remove:**
```typescript
// TODO: Replace with useSceneTags(movie.id.toString()).tags when Plan 01-03b is complete
const tags: never[] = [];
```

**Add import:**
```typescript
import { useSceneTags } from '../../hooks/useSceneTags';
```

**Replace in component body:**
```typescript
export function MovieDetailHeader({ movie }: MovieDetailHeaderProps) {
  const { selectedPhobias } = usePhobias();
  const { tags } = useSceneTags(movie.id.toString()); // NEW: Load tags from localStorage
  const { scores, getColor } = useDangerScore({ tags, selectedPhobias });
  // ... rest of component
}
```

**Verification:**
- Overall danger score section shows correct value (highest phobia score)
- Phobia-specific scores display correctly for each selected phobia
- When no tags exist, scores show 0 (existing empty state behavior preserved)
- Color coding matches intensity (green/yellow/red via getDangerColor function)

**Reference:** The danger score display logic at lines 99-156 already handles scores correctly; no changes needed there.
  </implementation>
</task>

<task name="add-integration-tests" id="task-3">
  <objective>Add integration tests verifying danger scores update with tag changes</objective>
  <acceptance>
    - [ ] src/hooks/useDangerScore.test.tsx created
    - [ ] Test: Danger scores are 0 when no tags exist
    - [ ] Test: Danger scores calculate correctly when tags are added
    - [ ] Test: Overall score equals max of phobia-specific scores
    - [ ] Test: Only selected phobias contribute to scores
    - [ ] All tests pass
  </acceptance>
  <implementation>
Create src/hooks/useDangerScore.test.tsx:

```typescript
import { renderHook } from '@testing-library/react';
import { useDangerScore } from './useDangerScore';
import type { SceneTag } from '../types/phobia';

describe('useDangerScore', () => {
  it('returns 0 scores when no tags exist', () => {
    const { result } = renderHook(() =>
      useDangerScore({
        tags: [],
        selectedPhobias: ['arachnophobia', 'acrophobia'],
      })
    );

    expect(result.current.scores.overall).toBe(0);
    expect(result.current.scores.byPhobia.arachnophobia).toBe(0);
    expect(result.current.scores.byPhobia.acrophobia).toBe(0);
  });

  it('calculates danger scores correctly when tags exist', () => {
    const tags: SceneTag[] = [
      { phobiaId: 'arachnophobia', intensity: 7, timestamp: 120, notes: '', count: 1 },
      { phobiaId: 'acrophobia', intensity: 5, timestamp: 240, notes: '', count: 1 },
      { phobiaId: 'arachnophobia', intensity: 9, timestamp: 360, notes: '', count: 2 },
    ];

    const { result } = renderHook(() =>
      useDangerScore({
        tags,
        selectedPhobias: ['arachnophobia', 'acrophobia'],
      })
    );

    // Max intensity for arachnophobia is 9
    expect(result.current.scores.byPhobia.arachnophobia).toBe(9);
    // Max intensity for acrophobia is 5
    expect(result.current.scores.byPhobia.acrophobia).toBe(5);
    // Overall score is max of all phobia scores (9)
    expect(result.current.scores.overall).toBe(9);
  });

  it('only includes selected phobias in scores', () => {
    const tags: SceneTag[] = [
      { phobiaId: 'arachnophobia', intensity: 8, timestamp: 120, notes: '', count: 1 },
      { phobiaId: 'claustrophobia', intensity: 10, timestamp: 240, notes: '', count: 1 },
    ];

    const { result } = renderHook(() =>
      useDangerScore({
        tags,
        selectedPhobias: ['arachnophobia'], // Only arachnophobia selected
      })
    );

    expect(result.current.scores.byPhobia.arachnophobia).toBe(8);
    expect(result.current.scores.byPhobia.claustrophobia).toBeUndefined();
    expect(result.current.scores.overall).toBe(8);
  });

  it('returns correct danger color based on score', () => {
    const { result: lowScore } = renderHook(() =>
      useDangerScore({ tags: [], selectedPhobias: [] })
    );
    expect(lowScore.current.getColor(25)).toBe('#4caf50'); // Green

    const { result: mediumScore } = renderHook(() =>
      useDangerScore({ tags: [], selectedPhobias: [] })
    );
    expect(mediumScore.current.getColor(50)).toBe('#ff9800'); // Yellow

    const { result: highScore } = renderHook(() =>
      useDangerScore({ tags: [], selectedPhobias: [] })
    );
    expect(highScore.current.getColor(85)).toBe('#f44336'); // Red
  });
});
```

**Test setup:**
- Uses @testing-library/react for React hooks testing
- Tests core danger score calculation logic with real tag data
- Verifies color coding thresholds (≤30 green, 31-70 yellow, >70 red)

**Dependencies:**
If @testing-library/react not installed, run:
```bash
npm install --save-dev @testing-library/react @testing-library/jest-dom
```

**Run tests:**
```bash
npm test -- useDangerScore.test.tsx
```
  </implementation>
</task>

## Must-Haves (Goal-Backward Verification)

Phase goal: Build core phobia-aware browsing + danger scores + tagging framework

This plan must deliver:
- [x] MovieCard danger scores wired to localStorage tags
- [x] MovieDetailHeader danger scores wired to localStorage tags
- [x] Danger scores update when tags are added/removed
- [x] Integration tests verify scoring behavior
- [x] No regression in color coding or empty state handling
- [ ] useSceneTags hook exists (already implemented in 01-03b)
- [ ] calculateDangerScores function exists (already implemented in 01-01)

**Gap Closure:** This plan closes the "Personalized danger score calculation" gap identified in 01-VERIFICATION.md. After execution, danger scores will display real values based on community-contributed scene tags instead of always showing 0.

**Next Gap:** Plan 01-05 will address "Average intensity ratings calculation" gap.
