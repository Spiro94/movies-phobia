# Phase 1 - Plan 01-01: Core API & Data Architecture

---
wave: 1
depends_on: []
files_modified:
  - src/types/movie.ts
  - src/types/phobia.ts
  - src/types/danger.ts
  - src/utils/tmdb.ts
  - src/utils/phobias.ts
  - src/utils/dangerScoring.ts
  - src/utils/storage.ts
  - src/hooks/usePhobias.ts
  - src/hooks/useDangerScore.ts
  - package.json
autonomous: true
---

## Objective

Establish the foundational data layer including TMDB API integration, phobia taxonomy, danger score algorithm, and persistence hooks.

## Overview

This plan creates the core data architecture that all UI components will depend on. It implements TMDB API client with TanStack Query for server state management, defines the DSM-5-aligned phobia taxonomy (15-25 curated phobias), establishes the danger score calculation algorithm (traffic-light color scale 0-100), and creates localStorage persistence hooks for user phobia selections. This foundation enables all subsequent UI work by providing clean, typed interfaces for movie data, phobia selections, and danger scoring.

The plan prioritizes getting real TMDB data flowing through the app and establishing the phobia selection persistence layer so that Browse UI (Plans 01-02a and 01-02b) can consume this immediately.

## Acceptance Criteria

- [ ] TMDB API client configured with Bearer token authentication
- [ ] TanStack Query installed and configured for pagination
- [ ] TypeScript types defined for TMDB movie responses
- [ ] Phobia taxonomy implemented with 15-25 DSM-5-aligned phobias
- [ ] Danger score calculation algorithm implemented with traffic-light color mapping
- [ ] localStorage persistence working for phobia selections
- [ ] usePhobias hook provides selection state + persistence
- [ ] useDangerScore hook calculates scores based on tags and selections
- [ ] All utilities have proper TypeScript types

<task name="install-dependencies" id="task-1">
  <objective>Install TanStack Query v5 and axios for API integration</objective>
  <acceptance>
    - [ ] @tanstack/react-query ^5.0.0 installed
    - [ ] axios ^1.6.0 installed (or using native fetch)
    - [ ] Dependencies added to package.json
    - [ ] npm install runs successfully
  </acceptance>
  <implementation>
Run npm install commands for TanStack Query v5 (industry standard for server state) and axios (HTTP client). Reference RESEARCH.md Section "Standard Stack" which confirms TanStack Query v5 for pagination/caching and axios for API calls. Use exact versions to avoid breaking changes.

```bash
npm install @tanstack/react-query
npm install axios
```

Alternative: Use native fetch instead of axios if response interceptors not needed (see RESEARCH.md Pattern 1).
  </implementation>
</task>

<task name="define-typescript-types" id="task-2">
  <objective>Create TypeScript type definitions for TMDB API responses, phobias, and danger scores</objective>
  <acceptance>
    - [ ] src/types/movie.ts created with Movie and TMDBResponse interfaces
    - [ ] src/types/phobia.ts created with Phobia and SceneTag interfaces
    - [ ] src/types/danger.ts created with DangerScore types
    - [ ] All types align with TMDB API v3 response structure
    - [ ] SceneTag includes timestamp, phobiaId, intensity (1-10), count
  </acceptance>
  <implementation>
Create three type files based on TMDB API v3 documentation and RESEARCH.md phobia taxonomy:

**src/types/movie.ts:**
Define Movie interface matching TMDB response: id, title, poster_path, overview, release_date, genre_ids, popularity, vote_average, vote_count. Define TMDBResponse interface with page, results[], total_pages, total_results (see RESEARCH.md "Code Examples" section).

**src/types/phobia.ts:**
Define Phobia interface: id (string), name (string), scientificName (string), category ('animal' | 'natural' | 'blood' | 'situational' | 'other'), description (optional string). Define SceneTag interface: timestamp (number in seconds), phobiaId (string), intensity (number 1-10), count (number of users who tagged).

**src/types/danger.ts:**
Define DangerScores type as Record<string, number> mapping phobiaId to score 0-100. Define DangerColor type for traffic-light mapping.

Reference RESEARCH.md "Phobia Taxonomy (Locked Research)" for phobia structure and "Pattern 3: Danger Score Calculation" for SceneTag shape.
  </implementation>
</task>

<task name="implement-phobia-taxonomy" id="task-3">
  <objective>Create curated list of 15-25 DSM-5-aligned phobias</objective>
  <acceptance>
    - [ ] src/utils/phobias.ts created with PHOBIAS constant array
    - [ ] List includes 15-25 phobias covering DSM-5 categories
    - [ ] Each phobia has id, name, scientificName, category, description
    - [ ] Categories: animal, natural, blood, situational, other
    - [ ] Common phobias included: arachnophobia, acrophobia, claustrophobia, hemophobia
  </acceptance>
  <implementation>
Create src/utils/phobias.ts exporting const PHOBIAS array. Use RESEARCH.md "Recommended Starting List (15-25 phobias)" table as baseline. Include high-prevalence phobias across all 5 DSM-5 categories:

**Animal:** arachnophobia (spiders), ophidiophobia (snakes), cynophobia (dogs)
**Natural Environment:** acrophobia (heights), aquaphobia (water), astraphobia (thunderstorms)
**Blood-Injection-Injury:** hemophobia (blood), trypanophobia (needles/injections)
**Situational:** claustrophobia (enclosed spaces), aviophobia (flying)
**Other:** trypophobia (holes), emetophobia (vomiting), phonophobia (loud sounds)

Use exact structure from RESEARCH.md "Phobia List in Code" example. Export helper function getPhobiaById(id: string): Phobia | undefined for lookups.

Rationale: 15-25 phobias covers ~80% of real-world cases (Pareto principle) while reducing cognitive load (RESEARCH.md "Why 15-25 not 500+").
  </implementation>
</task>

<task name="implement-tmdb-client" id="task-4">
  <objective>Create TMDB API client with Bearer token authentication and base configuration</objective>
  <acceptance>
    - [ ] src/utils/tmdb.ts created with API client
    - [ ] Bearer token authentication configured from environment variable
    - [ ] Base URL set to https://api.themoviedb.org/3
    - [ ] Helper functions for popular movies and search endpoints
    - [ ] Proper error handling for API failures
  </acceptance>
  <implementation>
Create src/utils/tmdb.ts with axios instance or fetch wrapper. Reference RESEARCH.md "Pattern 1: TMDB API Integration with TanStack Query" for exact structure.

**Configuration:**
- Base URL: https://api.themoviedb.org/3
- Auth: Bearer token in Authorization header
- Token from: import.meta.env.VITE_TMDB_API_KEY (Vite env variable pattern)
- Default params: language=en-US

**Functions to export:**
- fetchPopularMovies(page: number): Promise<TMDBResponse>
- searchMovies(query: string, page: number): Promise<TMDBResponse>

Use axios.get() with params object for query parameters. Reference RESEARCH.md "TMDB Popular Movies with Pagination" and "Movie Search by Title" for exact endpoint structure and response shape.

**Error handling:**
Catch axios errors, check for 429 (rate limit), throw meaningful error messages. RESEARCH.md "Pitfall 1: TMDB API Rate Limit Surprises" recommends exponential backoff on 429 - implement basic retry logic or let TanStack Query handle via retry config.

**Note:** User must provide TMDB API key in .env.local as VITE_TMDB_API_KEY. Document this requirement.
  </implementation>
</task>

<task name="implement-danger-scoring-algorithm" id="task-5">
  <objective>Create danger score calculation logic with traffic-light color mapping</objective>
  <acceptance>
    - [ ] src/utils/dangerScoring.ts created
    - [ ] calculateDangerScores function accepts tags and selectedPhobias
    - [ ] Returns DangerScores object mapping phobiaId to 0-100 score
    - [ ] Aggregates intensity weighted by user count
    - [ ] getDangerColor function maps score to traffic-light colors
    - [ ] Color thresholds: 0-30 green, 31-70 yellow, 71-100 red
  </acceptance>
  <implementation>
Create src/utils/dangerScoring.ts with two main exports:

**calculateDangerScores(tags: SceneTag[], selectedPhobias: string[]): DangerScores**
Implement algorithm from RESEARCH.md "Pattern 3: Danger Score Calculation":
1. Initialize scores object with selectedPhobias at 0
2. Aggregate tags by phobiaId: sum (intensity × count) and sum (count)
3. Calculate avgIntensity = totalIntensity / totalVotes
4. Convert to 0-100: score = Math.min(100, Math.round(avgIntensity × 10))
5. Return scores object

**getDangerColor(score: number): string**
Return hex color based on threshold:
- 0-30: '#4caf50' (green - safe)
- 31-70: '#ff9800' (orange - caution)
- 71-100: '#f44336' (red - danger)

Reference RESEARCH.md "Danger Score Color Scale" for exact color values and "Open Questions #4" confirming 0-30/31-70/71-100 thresholds.

**Edge cases:**
- Empty tags array: return all 0 scores for selectedPhobias
- No matching phobias in tags: return 0 for those phobias
- Intensity validation: ensure 1-10 range (clamp if needed)
  </implementation>
</task>

<task name="implement-storage-utilities" id="task-6">
  <objective>Create localStorage helpers for phobia selection persistence</objective>
  <acceptance>
    - [ ] src/utils/storage.ts created
    - [ ] Functions: savePhobias, loadPhobias, clearPhobias
    - [ ] Proper JSON serialization/deserialization
    - [ ] Error handling for QuotaExceededError
    - [ ] Type-safe returns (never assumes localStorage exists)
  </acceptance>
  <implementation>
Create src/utils/storage.ts with localStorage wrapper functions:

**savePhobias(phobias: string[]): void**
- JSON.stringify phobias array
- localStorage.setItem('selectedPhobias', json)
- Try/catch QuotaExceededError - log warning but don't crash
- Reference RESEARCH.md "Pitfall 2: localStorage Size Exceeded" for quota concerns

**loadPhobias(): string[]**
- localStorage.getItem('selectedPhobias')
- If null, return []
- Try JSON.parse, catch errors and return []
- Type guard: ensure result is string array

**clearPhobias(): void**
- localStorage.removeItem('selectedPhobias')

**Future-proofing:**
Add comment noting localStorage has 5MB limit; Phase 2+ may migrate to IndexedDB if scene tags exceed limits (see RESEARCH.md "Pitfall 2").

Reference RESEARCH.md "Pattern 2: Phobia Selection State + Persistence" for localStorage hydration pattern.
  </implementation>
</task>

<task name="create-use-phobias-hook" id="task-7">
  <objective>Build custom React hook for phobia selection state and persistence</objective>
  <acceptance>
    - [ ] src/hooks/usePhobias.ts created
    - [ ] Hook returns: selectedPhobias, togglePhobia, setPhobias
    - [ ] Hydrates from localStorage on mount
    - [ ] Persists to localStorage on selection change
    - [ ] Uses useCallback for stable function references
    - [ ] Proper TypeScript types for return value
  </acceptance>
  <implementation>
Create src/hooks/usePhobias.ts implementing pattern from RESEARCH.md "Pattern 2: Phobia Selection State + Persistence":

**Hook signature:**
```typescript
interface UsePhobiasReturn {
  selectedPhobias: string[];
  togglePhobia: (phobiaId: string) => void;
  setPhobias: (phobias: string[]) => void;
}

export const usePhobias = (): UsePhobiasReturn
```

**Implementation:**
1. useState with lazy initializer calling loadPhobias() from storage.ts
2. useEffect that calls savePhobias(selectedPhobias) when selectedPhobias changes
3. togglePhobia = useCallback that adds/removes phobiaId from array
4. setPhobias = direct setter (rename setSelectedPhobias for clarity)

**Key patterns:**
- Lazy initialization prevents calling loadPhobias on every render
- useCallback prevents toggle function recreation on every render
- Side effect (localStorage) in useEffect, not in event handler

Reference exact implementation in RESEARCH.md "Pattern 2" code example. This hook will be consumed by PhobiaModal and PhobiaSidebar components in Plans 01-02a and 01-02b.
  </implementation>
</task>

<task name="create-use-danger-score-hook" id="task-8">
  <objective>Build custom React hook for calculating danger scores from tags</objective>
  <acceptance>
    - [ ] src/hooks/useDangerScore.ts created
    - [ ] Hook accepts movie tags and returns danger scores
    - [ ] Uses selectedPhobias from usePhobias hook
    - [ ] Memoizes calculation with useMemo to prevent recalc on every render
    - [ ] Returns both scores object and getDangerColor helper
  </acceptance>
  <implementation>
Create src/hooks/useDangerScore.ts:

**Hook signature:**
```typescript
interface UseDangerScoreReturn {
  scores: DangerScores;
  getColor: (phobiaId: string) => string;
}

export const useDangerScore = (tags: SceneTag[]): UseDangerScoreReturn
```

**Implementation:**
1. Call usePhobias() to get selectedPhobias
2. useMemo(() => calculateDangerScores(tags, selectedPhobias), [tags, selectedPhobias])
3. Return scores object and helper function getColor(phobiaId) that looks up score and calls getDangerColor

**Optimization:**
useMemo prevents recalculating scores on every render - only when tags or selectedPhobias change. Reference RESEARCH.md "Anti-Patterns to Avoid" which warns against calculating danger score on every render.

**Usage pattern (for Plans 01-02a and 01-03a):**
```typescript
const { scores, getColor } = useDangerScore(movieTags);
// scores['arachnophobia'] => 75
// getColor('arachnophobia') => '#f44336'
```

This hook will be consumed by MovieCard component to display danger badges.
  </implementation>
</task>

## Must-Haves (Goal-Backward Verification)

Phase goal: Build core phobia-aware browsing + danger scores + tagging framework

This plan must deliver:
- [x] TMDB API integration complete (client + TanStack Query ready)
- [x] Phobia taxonomy defined (15-25 DSM-5 phobias in code)
- [x] Danger score algorithm implemented (0-100 with traffic-light colors)
- [x] Phobia selection persistence (localStorage hooks working)
- [x] TypeScript types for all data structures
- [x] Reusable hooks (usePhobias, useDangerScore) ready for UI consumption
- [ ] Browse UI (depends on Plans 01-02a and 01-02b)
- [ ] Scene tagging UI (depends on Plans 01-03a and 01-03b)
